<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Period Tracker</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .day-cell { 
            transition: all 0.2s ease-in-out; 
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        .day-cell:hover { transform: scale(1.05); }
        .day-cell.selected { transform: scale(0.95); background-color: #fca5a5; }
        .day-cell.period-logged { background-color: #fdbab8; color: #7f1d1d; font-weight: 600; }
        .day-cell.period-predicted { background-color: #fef2f2; color: #b91c1c; }
        .day-cell.fertile-window { background-color: #d1fae5; color: #065f46; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4 min-h-screen flex items-center justify-center">
    <div class="container mx-auto p-6 bg-white rounded-3xl shadow-xl max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-pink-500">Period Tracker</h1>
            <p class="text-gray-500 mt-2">A simple and user-friendly way to track your cycle.</p>
        </header>

        <main class="grid lg:grid-cols-3 gap-8">
            <!-- Main Tracking UI -->
            <section class="lg:col-span-2 flex flex-col gap-8">
                <!-- Persistent Alert Bar -->
                <div id="persistent-alert" class="bg-rose-200 text-rose-800 p-4 rounded-xl font-semibold shadow-md hidden">
                    <p id="alert-message"></p>
                </div>

                <!-- Calendar Section: Now with two months side-by-side -->
                <div class="bg-stone-50 p-6 rounded-2xl shadow-inner grid md:grid-cols-2 gap-8">
                    <!-- First Month Calendar -->
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <button id="prevMonthBtn" class="bg-pink-500 text-white p-2 rounded-full hover:bg-pink-600 transition-colors shadow-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <h3 id="monthTitle1" class="text-xl font-semibold text-center"></h3>
                            <button id="nextMonthBtn" class="bg-pink-500 text-white p-2 rounded-full hover:bg-pink-600 transition-colors shadow-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                        <div class="grid grid-cols-7 text-center font-semibold text-sm mb-2 text-pink-600">
                            <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                        </div>
                        <div id="calendar-grid1" class="grid grid-cols-7 gap-2 text-center"></div>
                    </div>
                    
                    <!-- Second Month Calendar -->
                    <div>
                        <h3 id="monthTitle2" class="text-xl font-semibold text-center mb-6"></h3>
                        <div class="grid grid-cols-7 text-center font-semibold text-sm mb-2 text-pink-600">
                            <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                        </div>
                        <div id="calendar-grid2" class="grid grid-cols-7 gap-2 text-center"></div>
                    </div>
                </div>

                <!-- Log Period and Reset Buttons -->
                <div class="flex justify-center mt-4 space-x-4">
                    <button id="logPeriodBtn" class="bg-pink-500 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-pink-600 transition-colors transform hover:scale-105">
                        Log Period Day
                    </button>
                    <button id="resetBtn" class="bg-gray-400 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-gray-500 transition-colors transform hover:scale-105">
                        Reset Data
                    </button>
                </div>
            </section>

            <!-- Tracking and Information Section -->
            <section class="bg-stone-50 p-6 rounded-2xl shadow-inner flex flex-col justify-between">
                <div>
                    <h2 class="text-2xl font-semibold mb-4 text-pink-500">Your Cycle At a Glance</h2>
                    
                    <!-- Prediction List Section -->
                    <div id="prediction-list" class="bg-white p-6 rounded-2xl shadow-sm mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-pink-500">Next Prediction</h3>
                        <ul id="upcoming-dates-list" class="space-y-4">
                            <!-- Upcoming dates will be generated here -->
                        </ul>
                    </div>

                    <div id="start-tracking-message" class="text-center text-gray-500 p-8">
                        <p class="text-lg font-bold mb-2">Ready to start tracking?</p>
                        <p class="text-sm">Click on a date in the calendar and then click the button below to log your first period day.</p>
                    </div>

                    <h2 class="text-2xl font-semibold mt-8 mb-4 text-pink-500">Settings</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="cycleLength" class="block text-sm font-medium text-gray-700">Typical Cycle Length (days)</label>
                            <input type="number" id="cycleLength" value="28" min="18" max="45" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm p-2">
                        </div>
                        <div>
                            <label for="periodLength" class="block text-sm font-medium text-gray-700">Typical Period Length (days)</label>
                            <input type="number" id="periodLength" value="5" min="2" max="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 sm:text-sm p-2">
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <h2 class="text-2xl font-semibold mb-2 text-pink-500">Calendar Key</h2>
                    <ul class="space-y-2">
                        <li class="flex items-center space-x-2">
                            <span class="inline-block w-4 h-4 rounded-full bg-red-200"></span>
                            <span>Predicted Period Days</span>
                        </li>
                        <li class="flex items-center space-x-2">
                            <span class="inline-block w-4 h-4 rounded-full bg-green-200"></span>
                            <span>Predicted Fertile Window</span>
                        </li>
                        <li class="flex items-center space-x-2">
                            <span class="inline-block w-4 h-4 rounded-full bg-blue-100"></span>
                            <span>Today's Date</span>
                        </li>
                    </ul>
                </div>
            </section>
        </main>
    </div>

    <!-- Custom Dialog -->
    <dialog id="message-dialog" class="rounded-xl shadow-lg p-6 max-w-sm">
        <h3 id="dialog-title" class="text-xl font-bold mb-2"></h3>
        <p id="dialog-message" class="text-gray-700 mb-4"></p>
        <div class="text-right">
            <button id="dialog-ok-btn" class="bg-pink-500 text-white px-4 py-2 rounded-full hover:bg-pink-600 transition-colors">OK</button>
        </div>
    </dialog>

    <!-- JavaScript for functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const calendarGrid1 = document.getElementById('calendar-grid1');
            const calendarGrid2 = document.getElementById('calendar-grid2');
            const monthTitle1 = document.getElementById('monthTitle1');
            const monthTitle2 = document.getElementById('monthTitle2');
            const prevMonthBtn = document.getElementById('prevMonthBtn');
            const nextMonthBtn = document.getElementById('nextMonthBtn');
            const logPeriodBtn = document.getElementById('logPeriodBtn');
            const resetBtn = document.getElementById('resetBtn'); // Get the new button
            const startTrackingMessage = document.getElementById('start-tracking-message');
            const cycleLengthInput = document.getElementById('cycleLength');
            const periodLengthInput = document.getElementById('periodLength');
            const persistentAlert = document.getElementById('persistent-alert');
            const alertMessage = document.getElementById('alert-message');
            const upcomingDatesList = document.getElementById('upcoming-dates-list');

            // --- State Management ---
            const STORAGE_KEY_DATA = 'period_tracker_v2_data';
            const STORAGE_KEY_SETTINGS = 'period_tracker_v2_settings';
            let currentDate = new Date();
            let selectedDate = null;
            let loggedPeriods = JSON.parse(localStorage.getItem(STORAGE_KEY_DATA)) || [];
            let settings = JSON.parse(localStorage.getItem(STORAGE_KEY_SETTINGS)) || { cycleLength: 28, periodLength: 5 };

            function saveData() {
                localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(loggedPeriods));
            }

            function saveSettings() {
                localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(settings));
            }

            // --- Date Utilities ---
            const toISO = date => date.toISOString().split('T')[0];
            const fromISO = iso => new Date(iso + 'T00:00:00');
            const addDays = (date, days) => {
                const d = new Date(date);
                d.setDate(d.getDate() + days);
                return d;
            };
            const diffDays = (date1, date2) => {
                const d1 = typeof date1 === 'string' ? fromISO(date1) : date1;
                const d2 = typeof date2 === 'string' ? fromISO(date2) : date2;
                return Math.round((d2 - d1) / (1000 * 60 * 60 * 24));
            };

            // --- Dialog function ---
            const messageDialog = document.getElementById('message-dialog');
            const dialogTitle = document.getElementById('dialog-title');
            const dialogMessage = document.getElementById('dialog-message');
            const dialogOkBtn = document.getElementById('dialog-ok-btn');

            function showInfoBox(title, message) {
                dialogTitle.textContent = title;
                dialogMessage.textContent = message;
                messageDialog.showModal();
            }

            dialogOkBtn.addEventListener('click', () => {
                messageDialog.close();
            });

            // --- Prediction Logic ---
            function getPredictions(numCycles = 12) {
                if (loggedPeriods.length === 0) return null;
                
                const allPredictions = [];
                let lastPeriod = fromISO(loggedPeriods[loggedPeriods.length - 1]);
                const cycleDays = parseInt(settings.cycleLength, 10);
                const periodDays = parseInt(settings.periodLength, 10);
                
                for (let i = 0; i < numCycles; i++) {
                    const nextPeriodStart = addDays(lastPeriod, cycleDays);
                    const periodEnd = addDays(nextPeriodStart, periodDays - 1);
                    const ovulationDay = addDays(nextPeriodStart, -14);
                    const fertileWindowStart = addDays(ovulationDay, -5);
                    const fertileWindowEnd = addDays(ovulationDay, 1);

                    allPredictions.push({
                        nextPeriodStart: toISO(nextPeriodStart),
                        periodEnd: toISO(periodEnd),
                        ovulationDay: toISO(ovulationDay),
                        fertileWindowStart: toISO(fertileWindowStart),
                        fertileWindowEnd: toISO(fertileWindowEnd)
                    });
                    
                    lastPeriod = nextPeriodStart;
                }

                return allPredictions;
            }

            // --- Rendering Functions ---
            function renderCalendar() {
                const year1 = currentDate.getFullYear();
                const month1 = currentDate.getMonth();

                const nextMonthDate = new Date(currentDate);
                nextMonthDate.setMonth(nextMonthDate.getMonth() + 1);
                const year2 = nextMonthDate.getFullYear();
                const month2 = nextMonthDate.getMonth();
                
                monthTitle1.textContent = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                monthTitle2.textContent = nextMonthDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                
                renderMonth(year1, month1, calendarGrid1);
                renderMonth(year2, month2, calendarGrid2);
                
                const predictions = getPredictions(12);
                renderUpcomingDatesList(predictions);
            }

            function renderMonth(year, month, calendarGrid) {
                calendarGrid.innerHTML = '';

                // Days from previous month
                const firstDay = new Date(year, month, 1);
                const startingDay = firstDay.getDay();
                for (let i = 0; i < startingDay; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'day-cell p-3 text-gray-400 cursor-not-allowed';
                    calendarGrid.appendChild(emptyCell);
                }

                // Days of the current month
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();
                const predictions = getPredictions(12);

                for (let i = 1; i <= daysInMonth; i++) {
                    const day = new Date(year, month, i);
                    const isoDate = toISO(day);

                    const cell = document.createElement('div');
                    cell.textContent = i;
                    cell.className = 'day-cell p-3 rounded-xl border border-gray-200 cursor-pointer';

                    if (day.getDate() === today.getDate() && day.getMonth() === today.getMonth() && day.getFullYear() === today.getFullYear()) {
                        cell.classList.add('bg-blue-100', 'font-bold');
                    }
                    if (loggedPeriods.includes(isoDate)) {
                        cell.classList.add('period-logged');
                    }

                    if (predictions) {
                        predictions.forEach(p => {
                            const predictedStart = fromISO(p.nextPeriodStart);
                            const predictedEnd = fromISO(p.periodEnd);
                            if (day >= predictedStart && day <= predictedEnd) {
                                cell.classList.add('period-predicted');
                            }
                            const fertileStart = fromISO(p.fertileWindowStart);
                            const fertileEnd = fromISO(p.fertileWindowEnd);
                            if (day >= fertileStart && day <= fertileEnd) {
                                cell.classList.add('fertile-window');
                            }
                        });
                    }

                    cell.addEventListener('click', () => {
                        document.querySelectorAll('.day-cell.selected').forEach(s => s.classList.remove('selected'));
                        cell.classList.add('selected');
                        selectedDate = isoDate;
                        updateLogButton();
                    });

                    calendarGrid.appendChild(cell);
                }
            }

            function renderUpcomingDatesList(predictions) {
                upcomingDatesList.innerHTML = '';
                if (!predictions || predictions.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = 'Log your first period to see a prediction.';
                    li.className = 'text-gray-500 italic';
                    upcomingDatesList.appendChild(li);
                    return;
                }

                // Only show the next prediction
                const p = predictions[0];
                
                // Add icons to the prediction list items
                const periodItem = document.createElement('li');
                periodItem.className = 'bg-white p-3 rounded-md shadow-sm flex items-center space-x-3';
                const nextPeriodDate = fromISO(p.nextPeriodStart).toLocaleDateString();
                periodItem.innerHTML = `<span class="text-xl">ðŸ©¸</span><p><span class="font-semibold text-pink-500">Period:</span> ${nextPeriodDate}</p>`;
                upcomingDatesList.appendChild(periodItem);

                const ovulationItem = document.createElement('li');
                ovulationItem.className = 'bg-white p-3 rounded-md shadow-sm flex items-center space-x-3';
                const ovulationDay = fromISO(p.ovulationDay).toLocaleDateString();
                ovulationItem.innerHTML = `<span class="text-xl">ðŸŒ¸</span><p><span class="font-semibold text-teal-500">Ovulation:</span> ${ovulationDay}</p>`;
                upcomingDatesList.appendChild(ovulationItem);
                
                const fertileItem = document.createElement('li');
                fertileItem.className = 'bg-white p-3 rounded-md shadow-sm flex items-center space-x-3';
                const fertileWindow = `${fromISO(p.fertileWindowStart).toLocaleDateString()} - ${fromISO(p.fertileWindowEnd).toLocaleDateString()}`;
                fertileItem.innerHTML = `<span class="text-xl">ðŸŒ¿</span><p><span class="font-semibold text-teal-500">Fertile Window:</span> ${fertileWindow}</p>`;
                upcomingDatesList.appendChild(fertileItem);
            }

            // --- UI Interaction Logic ---
            function updateLogButton() {
                if (selectedDate && loggedPeriods.includes(selectedDate)) {
                    logPeriodBtn.textContent = 'Unlog Period Day';
                    logPeriodBtn.classList.remove('bg-pink-500', 'hover:bg-pink-600');
                    logPeriodBtn.classList.add('bg-gray-400', 'hover:bg-gray-500');
                } else {
                    logPeriodBtn.textContent = 'Log Period Day';
                    logPeriodBtn.classList.remove('bg-gray-400', 'hover:bg-gray-500');
                    logPeriodBtn.classList.add('bg-pink-500', 'hover:bg-pink-600');
                }
            }

            logPeriodBtn.addEventListener('click', () => {
                if (!selectedDate) {
                    showInfoBox('No Date Selected', 'Please click on a date in the calendar first.');
                    return;
                }
                
                const index = loggedPeriods.indexOf(selectedDate);
                if (index > -1) {
                    loggedPeriods.splice(index, 1);
                } else {
                    loggedPeriods.push(selectedDate);
                    loggedPeriods.sort();
                }

                saveData();
                selectedDate = null;
                document.querySelectorAll('.day-cell.selected').forEach(s => s.classList.remove('selected'));
                renderCalendar();
                updateLogButton();
                checkPeriodAlert();
            });

            // New reset button logic
            resetBtn.addEventListener('click', () => {
                loggedPeriods = [];
                saveData();
                
                settings = { cycleLength: 28, periodLength: 5 };
                saveSettings();
                cycleLengthInput.value = settings.cycleLength;
                periodLengthInput.value = settings.periodLength;

                selectedDate = null;
                document.querySelectorAll('.day-cell.selected').forEach(s => s.classList.remove('selected'));

                renderCalendar();
                updateLogButton();
                checkPeriodAlert();
                showInfoBox('Data Reset', 'All your period data and settings have been cleared.');
            });

            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });

            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

            cycleLengthInput.addEventListener('change', (e) => {
                settings.cycleLength = e.target.value;
                saveSettings();
                renderCalendar();
            });

            periodLengthInput.addEventListener('change', (e) => {
                settings.periodLength = e.target.value;
                saveSettings();
                renderCalendar();
            });

            // Set initial input values from saved settings
            cycleLengthInput.value = settings.cycleLength;
            periodLengthInput.value = settings.periodLength;

            // --- Initial Render and Alert Logic ---
            function checkPeriodAlert() {
                const predictions = getPredictions(1);
                persistentAlert.style.display = 'none';

                if (predictions && loggedPeriods.length > 0) {
                    const nextPeriodDate = fromISO(predictions[0].nextPeriodStart);
                    const daysUntil = diffDays(new Date(), nextPeriodDate);
                    
                    if (daysUntil <= 2 && daysUntil >= 0) {
                        alertMessage.textContent = `Heads up! Your next period is predicted to start in ${daysUntil === 0 ? 'less than a day' : daysUntil + ' days'}.`;
                        persistentAlert.style.display = 'block';
                    }
                }
                
                // Show tracking reminder if it's been too long since the last entry
                if (loggedPeriods.length > 0) {
                    const lastLoggedDate = fromISO(loggedPeriods[loggedPeriods.length - 1]);
                    const daysSinceLast = diffDays(lastLoggedDate, new Date());
                    const typicalCycle = parseInt(settings.cycleLength, 10);
                    if (daysSinceLast > typicalCycle + 7) {
                        startTrackingMessage.style.display = 'block';
                        startTrackingMessage.innerHTML = `
                            <p class="text-lg font-bold mb-2">It's been a while!</p>
                            <p class="text-sm">Please log your most recent period day to get accurate predictions.</p>
                        `;
                    }
                } else {
                    startTrackingMessage.style.display = 'block';
                    startTrackingMessage.innerHTML = `
                        <p class="text-lg font-bold mb-2">Ready to start tracking?</p>
                        <p class="text-sm">Click on a date in the calendar and then click the button below to log your first period day.</p>
                    `;
                }
            }
            
            // Initial call to render and check for alerts
            renderCalendar();
            checkPeriodAlert();
        });
    </script>
</body>
</html>
